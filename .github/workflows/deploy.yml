name: Deploy

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Next.js app
      run: npm run build
      env:
        NEXT_PUBLIC_GOOGLE_MAPS_KEY: ${{ secrets.NEXT_PUBLIC_GOOGLE_MAPS_KEY }}

    - name: Create deployment package
      run: |
        mkdir -p deploy-package
        # Copy necessary files for production
        cp -r .next deploy-package/
        cp -r public deploy-package/ 2>/dev/null || true
        cp -r src deploy-package/
        cp -r scripts deploy-package/
        cp package.json deploy-package/
        cp package-lock.json deploy-package/
        # Create deployment info
        echo "${{ github.sha }}" > deploy-package/.deploy-sha
        echo "${{ github.ref }}" > deploy-package/.deploy-ref
        echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy-package/.deploy-time
        # Create tar archive
        tar -czf deploy.tar.gz deploy-package/

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to server
      run: |
        # Transfer deployment package
        scp deploy.tar.gz ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/
        
        # Execute deployment script on server
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
          set -e  # Exit on error
          
          APP_DIR="/opt/chs-spots/app"
          BACKUP_DIR="/opt/chs-spots/backups"
          DATA_DIR="/opt/chs-spots/data"
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          
          # Create backup
          echo "ðŸ“¦ Creating backup..."
          if [ -d "$APP_DIR" ]; then
            mkdir -p "$BACKUP_DIR"
            cp -r "$APP_DIR" "$BACKUP_DIR/app_$TIMESTAMP"
            echo "âœ… Backup created at $BACKUP_DIR/app_$TIMESTAMP"
          fi
          
          # Extract new deployment
          echo "ðŸ“¥ Extracting deployment package..."
          mkdir -p "$APP_DIR"
          cd "$APP_DIR"
          tar -xzf /tmp/deploy.tar.gz --strip-components=1 deploy-package/*
          
          # Install production dependencies
          echo "ðŸ“š Installing production dependencies..."
          npm ci --production --ignore-scripts
          
          # Build Next.js app (if needed, or use pre-built .next)
          echo "ðŸ—ï¸  Verifying build..."
          if [ ! -d ".next" ]; then
            echo "âš ï¸  .next directory not found, building..."
            npm run build
          fi
          
          # Restart application with PM2
          echo "ðŸ”„ Restarting application..."
          if pm2 list | grep -q "chs-spots"; then
            pm2 restart chs-spots
          else
            # First time setup
            pm2 start npm --name "chs-spots" -- start
            pm2 save
          fi
          
          # Wait a moment for app to start
          sleep 5
          
          # Health check
          echo "ðŸ¥ Running health check..."
          if curl -f http://localhost:3000/api/spots > /dev/null 2>&1; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed - rolling back..."
            # Rollback to previous backup
            if [ -d "$BACKUP_DIR/app_$TIMESTAMP" ]; then
              rm -rf "$APP_DIR"
              cp -r "$BACKUP_DIR/app_$TIMESTAMP" "$APP_DIR"
              cd "$APP_DIR"
              pm2 restart chs-spots
              echo "âœ… Rolled back to previous version"
            fi
            exit 1
          fi
          
          # Cleanup
          rm /tmp/deploy.tar.gz
          
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“ Deployment SHA: $(cat .deploy-sha 2>/dev/null || echo 'unknown')"
        ENDSSH

    - name: Cleanup
      if: always()
      run: |
        rm -rf deploy-package deploy.tar.gz
