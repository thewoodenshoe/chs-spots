# Nginx Configuration for CHS Finds (chsfinds.com)
# Place at: /etc/nginx/sites-available/chs-spots
# Enable: sudo ln -sf /etc/nginx/sites-available/chs-spots /etc/nginx/sites-enabled/
# Test: sudo nginx -t && sudo systemctl reload nginx
# With Cloudflare: SSL is at the edge; Nginx listens on 80 only.
#
# One-time setup on server:
#   sudo mkdir -p /etc/nginx/ssl
#   sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout /etc/nginx/ssl/chsfinds-selfsigned.key \
#     -out /etc/nginx/ssl/chsfinds-selfsigned.crt -subj "/CN=chsfinds.com"
#   sudo sh -c "echo 'demo:$(openssl passwd -apr1 demo)' > /etc/nginx/.htpasswd_reports"

# Domain (Cloudflare) and default for port 80 so any Host is handled here
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name chsfinds.com www.chsfinds.com _;

    # Umami analytics proxy (Umami runs on 127.0.0.1:3001)
    location /u/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Reports – static files with basic auth (demo/demo)
    location /reports/ {
        alias /var/www/reports/;
        auth_basic "CHS Finds Reports";
        auth_basic_user_file /etc/nginx/.htpasswd_reports;
        autoindex on;
    }

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Direct IP:8080 access (how it used to work before domain)
server {
    listen 8080;
    listen [::]:8080;
    server_name _;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# HTTPS (port 443) – required when Cloudflare SSL is Full or Full (Strict)
server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    server_name chsfinds.com www.chsfinds.com _;

    ssl_certificate /etc/nginx/ssl/chsfinds-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/chsfinds-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Umami analytics proxy
    location /u/ {
        proxy_pass http://127.0.0.1:3001/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Reports – static files with basic auth
    location /reports/ {
        alias /var/www/reports/;
        auth_basic "CHS Finds Reports";
        auth_basic_user_file /etc/nginx/.htpasswd_reports;
        autoindex on;
    }

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
